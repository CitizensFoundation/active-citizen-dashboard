<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout-classes.html">

<link rel="import" href="yp-ajax/yp-ajax.html">
<link rel="import" href="ac-linkify-and-emoji.html">

<dom-module id="google-translate">
  <style>
    .translatedBy {
      color: #aaa;
      font-size: 9px;
    }

    .translatedText {
      border-color: #fff;
    }

    a:link {
      color: #444;
    }
  </style>

  <template>
    <template is="dom-if" if="[[translatedText]]">
      <div class="layout vertical">
        <div id="translatedTextWithEmoji"></div>
        <div class="translatedBy">translated by Google Translate</div>
      </div>
    </template>
    <div class="layout horizontal center-center" hidden>
      <yp-ajax id="translateApi" dispatch-error on-response="_translatedResponse"></yp-ajax>
      <yp-ajax id="checkLanguageApi" dispatch-error on-response="_languageDetected"></yp-ajax>
      <yp-ajax id="updateLanguage" method="PUT"></yp-ajax>
    </div>


  </template>a

  <script>

    Polymer({

      is: 'google-translate',

      properties: {

        item: {
          type: Object,
          observer: '_itemChanged'
        },

        translatedResponse: {
          type: Object,
          observer: "_translatedResponseChanged"
        },

        action: {
          type: String
        },

        apiKey: {
          type: String
        },

        textToTranslate: {
          type: String
        },

        languageDetected: {
          type: Object,
          observer: '_languageDetected'
        },

        itemId: {
          type: Number
        },

        sourceLanguage: {
          type: String
        },

        translatedText: {
          type: String,
          notify: true
        },

        translatedTextChanged: {
          type: Boolean,
          computed: '_translatedTextChanged(item, translatedText)'
        }
      },

      behaviors: [
        Polymer.AcLinkifyAndEmjoi
      ],

      _translatedTextChanged: function (item, text) {
        this.async(function () {
          if (item && text && this.$$("#translatedTextWithEmoji")) {
            this.$$("#translatedTextWithEmoji").innerHTML = this.addLinksAndEmjois(text);
          } else if (this.$$("#translatedTextWithEmoji")) {
            this.$$("#translatedTextWithEmoji").innerHTML = "";
          }
        }, 50);
      },

      _translatedResponse: function (event, detail) {
        var value = detail.response;
        if (value && value.data.translations && value.data.translations.length > 0) {
          var translatedText = value.data.translations[0].translatedText;
          this.set('translatedText', translatedText);
          this.$$("#updateLanguage").url = "/api/news_items/"+this.itemId+"/add_translation";
          this.$$("#updateLanguage").body = { translated_text: translatedText, language: this.sourceLanguage};
          this.$$("#updateLanguage").generateRequest();
        }
      },

      _removeBrackets: function (text) {
        return text.replace(/\[/g, "").replace(/\]/g, "").replace(/\&#39;/g, "").replace(/\&quot;/g, "").replace(/\&amp;/g, "");
      },

      _abortRequest: function (ajax) {
        if (ajax.lastRequest) {
          console.warn("Aborting request");
          ajax.lastRequest.abort();
        }
      },

      _itemChanged: function (item) {
        if (item) {
          this._abortRequest(this.$.checkLanguageApi);
          this._abortRequest(this.$.updateLanguage);
          this._abortRequest(this.$.translateApi);
          if (item.language=='en') {
            this.set('translatedText', null);
          } else if (item.translated_text) {
            this.set('translatedText', this._removeBrackets(item.translated_text));
          } else {
            if (item.description) {
              this.set('textToTranslate', this._removeBrackets(item.description));
              this.$$("#checkLanguageApi").url = "https://www.googleapis.com/language/translate/v2/detect";
              this.$$("#checkLanguageApi").params = {
                key: this.apiKey,
                q: this.textToTranslate
              };
              this.$$("#checkLanguageApi").generateRequest();
            } else {
              this.set('translatedText', null);
            }
          }
        } else {
          this.set('translatedText', null);
        }
      },

      _languageDetected: function (event, detail) {
        var value = detail.response;
        if (value && value.data.detections[0][0].language!="en") {
          this.set('sourceLanguage', value.data.detections[0][0].language);
          this.$$("#translateApi").url = "https://www.googleapis.com/language/translate/v2";
          this.$$("#translateApi").params = {
            key: this.apiKey,
            target: 'en',
            q: this.textToTranslate
          };
          this.$$("#translateApi").generateRequest();
        } else if (value && value.data.detections[0][0].language=="en") {
          this.$$("#updateLanguage").url = "/api/news_items/"+this.itemId+"/update_language";
          this.$$("#updateLanguage").body = { language: "en"};
          this.$$("#updateLanguage").generateRequest();
          this.set('translatedText', null);
        } else {
          this.set('translatedText', null);
        }
      }
    });
  </script>

</dom-module>
